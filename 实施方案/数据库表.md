# 🗃️ 智能提醒事项Web App - 数据库设计文档

## 📋 目录

- [数据库概述](#数据库概述)
- [用户管理表](#用户管理表)
- [任务管理表](#任务管理表)
- [时间线管理表](#时间线管理表)
- [提醒系统表](#提醒系统表)
- [数据分析表](#数据分析表)
- [系统配置表](#系统配置表)
- [索引设计](#索引设计)
- [数据关系图](#数据关系图)
- [数据迁移策略](#数据迁移策略)

---

## 🗄️ 数据库概述

### 技术选型
- **主数据库**: SQL Server 2022
- **缓存数据库**: Redis 7.0+ / Azure Redis Cache
- **搜索引擎**: Azure Cognitive Search（中期阶段）
- **数据仓库**: Azure Synapse Analytics（长期阶段）

### 设计原则
- **规范化**: 遵循第三范式，减少数据冗余
- **性能优化**: 合理使用索引，优化查询性能
- **扩展性**: 支持水平扩展和垂直扩展
- **安全性**: 数据加密，访问控制，审计日志
- **一致性**: ACID特性，事务管理，数据验证

### 命名规范
- **表名**: 小写字母，下划线分隔，复数形式
- **字段名**: 小写字母，下划线分隔
- **索引名**: `idx_表名_字段名`
- **外键名**: `fk_表名_引用表名`
- **约束名**: `ck_表名_字段名_约束类型`

---

## 👥 用户管理表

### users（用户表）
**描述**: 存储用户基本信息和认证数据

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 用户唯一标识 |
| email | VARCHAR(255) | UNIQUE NOT NULL | - | 邮箱地址 |
| phone | VARCHAR(20) | UNIQUE | NULL | 手机号码 |
| password_hash | VARCHAR(255) | NOT NULL | - | 密码哈希值 |
| name | VARCHAR(100) | NOT NULL | - | 用户姓名 |
| avatar_url | NVARCHAR(MAX) | - | NULL | 头像URL |
| status | VARCHAR(20) | NOT NULL | 'active' | 用户状态 |
| email_verified | BIT | NOT NULL | 0 | 邮箱验证状态 |
| phone_verified | BIT | NOT NULL | 0 | 手机验证状态 |
| last_login_at | DATETIME2 | - | NULL | 最后登录时间 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_users_email` (email)
- `idx_users_phone` (phone)
- `idx_users_status` (status)
- `idx_users_created_at` (created_at)

### user_profiles（用户资料表）
**描述**: 存储用户详细资料和偏好设置

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 记录唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| bio | NVARCHAR(MAX) | - | NULL | 个人简介 |
| location | VARCHAR(100) | - | NULL | 地理位置 |
| timezone | VARCHAR(50) | NOT NULL | 'UTC' | 时区设置 |
| language | VARCHAR(10) | NOT NULL | 'zh-CN' | 语言偏好 |
| date_format | VARCHAR(20) | NOT NULL | 'YYYY-MM-DD' | 日期格式 |
| time_format | VARCHAR(10) | NOT NULL | '24h' | 时间格式 |
| theme | VARCHAR(20) | NOT NULL | 'light' | 主题设置 |
| notification_preferences | NVARCHAR(MAX) | NOT NULL | '{}' | 通知偏好(JSON) |
| privacy_settings | NVARCHAR(MAX) | NOT NULL | '{}' | 隐私设置(JSON) |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_user_profiles_user_id` (user_id)
- `idx_user_profiles_timezone` (timezone)

### user_sessions（用户会话表）
**描述**: 存储用户登录会话信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 会话唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| session_token | VARCHAR(255) | UNIQUE NOT NULL | - | 会话令牌 |
| refresh_token | VARCHAR(255) | UNIQUE | NULL | 刷新令牌 |
| device_info | NVARCHAR(MAX) | - | NULL | 设备信息(JSON) |
| ip_address | VARCHAR(45) | - | NULL | IP地址 |
| user_agent | NVARCHAR(MAX) | - | NULL | 用户代理 |
| expires_at | DATETIME2 | NOT NULL | - | 过期时间 |
| is_active | BIT | NOT NULL | 1 | 是否活跃 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_user_sessions_user_id` (user_id)
- `idx_user_sessions_session_token` (session_token)
- `idx_user_sessions_refresh_token` (refresh_token)
- `idx_user_sessions_expires_at` (expires_at)

### user_oauth_accounts（第三方账户表）
**描述**: 存储第三方登录账户信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 记录唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| provider | VARCHAR(50) | NOT NULL | - | 提供商 |
| provider_user_id | VARCHAR(255) | NOT NULL | - | 提供商用户ID |
| access_token | NVARCHAR(MAX) | - | NULL | 访问令牌 |
| refresh_token | NVARCHAR(MAX) | - | NULL | 刷新令牌 |
| expires_at | DATETIME2 | - | NULL | 令牌过期时间 |
| profile_data | NVARCHAR(MAX) | - | NULL | 用户资料数据(JSON) |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_user_oauth_accounts_user_id` (user_id)
- `idx_user_oauth_accounts_provider` (provider)
- `idx_user_oauth_accounts_provider_user_id` (provider, provider_user_id)

---

## 📋 任务管理表

### tasks（任务表）
**描述**: 存储任务基本信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 任务唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| title | VARCHAR(255) | NOT NULL | - | 任务标题 |
| description | NVARCHAR(MAX) | - | NULL | 任务描述 |
| start_time | DATETIME2 | - | NULL | 开始时间 |
| end_time | DATETIME2 | - | NULL | 结束时间 |
| estimated_hours | DECIMAL(5,2) | - | NULL | 预估工时 |
| actual_hours | DECIMAL(5,2) | - | NULL | 实际工时 |
| priority | VARCHAR(20) | NOT NULL | 'medium' | 优先级 |
| status | VARCHAR(20) | NOT NULL | 'pending' | 任务状态 |
| progress | INTEGER | NOT NULL | 0 | 进度百分比 |
| category | VARCHAR(50) | - | NULL | 任务分类 |
| tags | NVARCHAR(MAX) | - | NULL | 标签数组(JSON) |
| color | VARCHAR(7) | - | NULL | 任务颜色 |
| is_recurring | BIT | NOT NULL | 0 | 是否重复任务 |
| recurrence_rule | NVARCHAR(MAX) | - | NULL | 重复规则(JSON) |
| parent_task_id | UNIQUEIDENTIFIER | FOREIGN KEY | NULL | 父任务ID |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |
| completed_at | DATETIME2 | - | NULL | 完成时间 |

**索引**:
- `idx_tasks_user_id` (user_id)
- `idx_tasks_status` (status)
- `idx_tasks_priority` (priority)
- `idx_tasks_category` (category)
- `idx_tasks_start_time` (start_time)
- `idx_tasks_end_time` (end_time)
- `idx_tasks_parent_task_id` (parent_task_id)
- `idx_tasks_user_status` (user_id, status)
- `idx_tasks_user_category` (user_id, category)

### task_details（任务详情表）
**描述**: 存储任务详细信息和附件

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 记录唯一标识 |
| task_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 任务ID |
| content | NVARCHAR(MAX) | - | NULL | 详细内容 |
| attachments | NVARCHAR(MAX) | - | NULL | 附件信息(JSON) |
| metadata | NVARCHAR(MAX) | - | NULL | 元数据(JSON) |
| version | INTEGER | NOT NULL | 1 | 版本号 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_task_details_task_id` (task_id)

### task_dependencies（任务依赖关系表）
**描述**: 存储任务之间的依赖关系

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 记录唯一标识 |
| task_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 任务ID |
| depends_on_task_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 依赖任务ID |
| dependency_type | VARCHAR(10) | NOT NULL | 'FS' | 依赖类型 |
| lag_days | INTEGER | NOT NULL | 0 | 延迟天数 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |

**索引**:
- `idx_task_dependencies_task_id` (task_id)
- `idx_task_dependencies_depends_on_task_id` (depends_on_task_id)
- `idx_task_dependencies_both` (task_id, depends_on_task_id)

### task_categories（任务分类表）
**描述**: 存储任务分类信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 分类唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| name | VARCHAR(100) | NOT NULL | - | 分类名称 |
| description | NVARCHAR(MAX) | - | NULL | 分类描述 |
| color | VARCHAR(7) | - | NULL | 分类颜色 |
| icon | VARCHAR(50) | - | NULL | 分类图标 |
| parent_category_id | UNIQUEIDENTIFIER | FOREIGN KEY | NULL | 父分类ID |
| sort_order | INTEGER | NOT NULL | 0 | 排序顺序 |
| is_default | BIT | NOT NULL | 0 | 是否默认分类 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_task_categories_user_id` (user_id)
- `idx_task_categories_parent_category_id` (parent_category_id)
- `idx_task_categories_user_name` (user_id, name)

### task_templates（任务模板表）
**描述**: 存储任务模板信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 模板唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| name | VARCHAR(255) | NOT NULL | - | 模板名称 |
| description | NVARCHAR(MAX) | - | NULL | 模板描述 |
| template_data | NVARCHAR(MAX) | NOT NULL | - | 模板数据(JSON) |
| category | VARCHAR(50) | - | NULL | 模板分类 |
| tags | NVARCHAR(MAX) | - | NULL | 标签数组(JSON) |
| is_public | BIT | NOT NULL | 0 | 是否公开 |
| usage_count | INTEGER | NOT NULL | 0 | 使用次数 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_task_templates_user_id` (user_id)
- `idx_task_templates_category` (category)
- `idx_task_templates_is_public` (is_public)

---

## 📊 时间线管理表

### timeline_nodes（时间线节点表）
**描述**: 存储时间线节点信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 节点唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| task_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 任务ID |
| node_type | VARCHAR(20) | NOT NULL | 'task' | 节点类型 |
| title | VARCHAR(255) | NOT NULL | - | 节点标题 |
| start_time | DATETIME2 | NOT NULL | - | 开始时间 |
| end_time | DATETIME2 | NOT NULL | - | 结束时间 |
| planned_start_time | DATETIME2 | - | NULL | 计划开始时间 |
| planned_end_time | DATETIME2 | - | NULL | 计划结束时间 |
| progress | INTEGER | NOT NULL | 0 | 进度百分比 |
| status | VARCHAR(20) | NOT NULL | 'pending' | 节点状态 |
| color | VARCHAR(7) | - | NULL | 节点颜色 |
| position_x | INTEGER | - | NULL | X坐标位置 |
| position_y | INTEGER | - | NULL | Y坐标位置 |
| metadata | NVARCHAR(MAX) | - | NULL | 元数据(JSON) |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_timeline_nodes_user_id` (user_id)
- `idx_timeline_nodes_task_id` (task_id)
- `idx_timeline_nodes_start_time` (start_time)
- `idx_timeline_nodes_end_time` (end_time)
- `idx_timeline_nodes_status` (status)

### timeline_events（时间线事件表）
**描述**: 存储时间线事件和里程碑

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 事件唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| event_type | VARCHAR(20) | NOT NULL | 'milestone' | 事件类型 |
| title | VARCHAR(255) | NOT NULL | - | 事件标题 |
| description | NVARCHAR(MAX) | - | NULL | 事件描述 |
| event_time | DATETIME2 | NOT NULL | - | 事件时间 |
| color | VARCHAR(7) | - | NULL | 事件颜色 |
| icon | VARCHAR(50) | - | NULL | 事件图标 |
| is_completed | BIT | NOT NULL | 0 | 是否完成 |
| completed_at | DATETIME2 | - | NULL | 完成时间 |
| metadata | NVARCHAR(MAX) | - | NULL | 元数据(JSON) |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_timeline_events_user_id` (user_id)
- `idx_timeline_events_event_time` (event_time)
- `idx_timeline_events_event_type` (event_type)
- `idx_timeline_events_is_completed` (is_completed)

### gantt_data（甘特图数据表）
**描述**: 存储甘特图相关数据

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 记录唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| task_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 任务ID |
| gantt_data | NVARCHAR(MAX) | NOT NULL | - | 甘特图数据(JSON) |
| view_settings | NVARCHAR(MAX) | - | NULL | 视图设置(JSON) |
| filters | NVARCHAR(MAX) | - | NULL | 过滤器设置(JSON) |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_gantt_data_user_id` (user_id)
- `idx_gantt_data_task_id` (task_id)

### time_blocks（时间块表）
**描述**: 存储专注时间和时间块信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 时间块唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| task_id | UNIQUEIDENTIFIER | FOREIGN KEY | NULL | 关联任务ID |
| title | VARCHAR(255) | NOT NULL | - | 时间块标题 |
| start_time | DATETIME2 | NOT NULL | - | 开始时间 |
| end_time | DATETIME2 | NOT NULL | - | 结束时间 |
| duration_minutes | INTEGER | NOT NULL | - | 持续时间（分钟） |
| block_type | VARCHAR(20) | NOT NULL | 'focus' | 时间块类型 |
| status | VARCHAR(20) | NOT NULL | 'planned' | 状态 |
| notes | NVARCHAR(MAX) | - | NULL | 备注 |
| interruptions | INTEGER | NOT NULL | 0 | 中断次数 |
| productivity_score | INTEGER | - | NULL | 生产力评分 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_time_blocks_user_id` (user_id)
- `idx_time_blocks_task_id` (task_id)
- `idx_time_blocks_start_time` (start_time)
- `idx_time_blocks_end_time` (end_time)
- `idx_time_blocks_block_type` (block_type)

---

## 🔔 提醒系统表

### reminders（提醒表）
**描述**: 存储提醒基本信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 提醒唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| task_id | UNIQUEIDENTIFIER | FOREIGN KEY | NULL | 关联任务ID |
| title | VARCHAR(255) | NOT NULL | - | 提醒标题 |
| message | NVARCHAR(MAX) | - | NULL | 提醒消息 |
| reminder_time | DATETIME2 | NOT NULL | - | 提醒时间 |
| reminder_type | VARCHAR(20) | NOT NULL | 'web' | 提醒类型 |
| status | VARCHAR(20) | NOT NULL | 'pending' | 提醒状态 |
| priority | VARCHAR(20) | NOT NULL | 'normal' | 优先级 |
| channels | NVARCHAR(MAX) | NOT NULL | '["web"]' | 提醒渠道(JSON) |
| repeat_rule | NVARCHAR(MAX) | - | NULL | 重复规则(JSON) |
| sent_at | DATETIME2 | - | NULL | 发送时间 |
| acknowledged_at | DATETIME2 | - | NULL | 确认时间 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_reminders_user_id` (user_id)
- `idx_reminders_task_id` (task_id)
- `idx_reminders_reminder_time` (reminder_time)
- `idx_reminders_status` (status)
- `idx_reminders_user_status` (user_id, status)

### reminder_rules（提醒规则表）
**描述**: 存储提醒规则和模板

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 规则唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| name | VARCHAR(255) | NOT NULL | - | 规则名称 |
| description | NVARCHAR(MAX) | - | NULL | 规则描述 |
| rule_type | VARCHAR(20) | NOT NULL | 'template' | 规则类型 |
| trigger_conditions | NVARCHAR(MAX) | NOT NULL | - | 触发条件(JSON) |
| reminder_settings | NVARCHAR(MAX) | NOT NULL | - | 提醒设置(JSON) |
| is_active | BIT | NOT NULL | 1 | 是否激活 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_reminder_rules_user_id` (user_id)
- `idx_reminder_rules_rule_type` (rule_type)
- `idx_reminder_rules_is_active` (is_active)

### reminder_history（提醒历史表）
**描述**: 存储提醒发送历史

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 记录唯一标识 |
| reminder_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 提醒ID |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| channel | VARCHAR(20) | NOT NULL | - | 发送渠道 |
| status | VARCHAR(20) | NOT NULL | - | 发送状态 |
| sent_at | DATETIME2 | NOT NULL | GETDATE() | 发送时间 |
| delivered_at | DATETIME2 | - | NULL | 送达时间 |
| read_at | DATETIME2 | - | NULL | 阅读时间 |
| error_message | NVARCHAR(MAX) | - | NULL | 错误信息 |
| retry_count | INTEGER | NOT NULL | 0 | 重试次数 |
| metadata | NVARCHAR(MAX) | - | NULL | 元数据(JSON) |

**索引**:
- `idx_reminder_history_reminder_id` (reminder_id)
- `idx_reminder_history_user_id` (user_id)
- `idx_reminder_history_sent_at` (sent_at)
- `idx_reminder_history_status` (status)

### notification_settings（通知设置表）
**描述**: 存储用户通知设置

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 设置唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| channel | VARCHAR(20) | NOT NULL | - | 通知渠道 |
| is_enabled | BIT | NOT NULL | 1 | 是否启用 |
| settings | NVARCHAR(MAX) | NOT NULL | '{}' | 渠道设置(JSON) |
| quiet_hours_start | TIME | - | NULL | 静音开始时间 |
| quiet_hours_end | TIME | - | NULL | 静音结束时间 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_notification_settings_user_id` (user_id)
- `idx_notification_settings_channel` (channel)

---

## 📊 数据分析表

### user_activities（用户活动表）
**描述**: 存储用户活动记录

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 记录唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| activity_type | VARCHAR(50) | NOT NULL | - | 活动类型 |
| activity_data | NVARCHAR(MAX) | NOT NULL | - | 活动数据(JSON) |
| session_id | UNIQUEIDENTIFIER | - | NULL | 会话ID |
| ip_address | VARCHAR(45) | - | NULL | IP地址 |
| user_agent | NVARCHAR(MAX) | - | NULL | 用户代理 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |

**索引**:
- `idx_user_activities_user_id` (user_id)
- `idx_user_activities_activity_type` (activity_type)
- `idx_user_activities_created_at` (created_at)
- `idx_user_activities_user_type_time` (user_id, activity_type, created_at)

### task_statistics（任务统计表）
**描述**: 存储任务统计数据

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 记录唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| task_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 任务ID |
| stat_date | DATE | NOT NULL | - | 统计日期 |
| time_spent_minutes | INTEGER | NOT NULL | 0 | 花费时间 |
| progress_change | INTEGER | NOT NULL | 0 | 进度变化 |
| status_changes | INTEGER | NOT NULL | 0 | 状态变化次数 |
| interruptions | INTEGER | NOT NULL | 0 | 中断次数 |
| efficiency_score | DECIMAL(3,2) | - | NULL | 效率评分 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |

**索引**:
- `idx_task_statistics_user_id` (user_id)
- `idx_task_statistics_task_id` (task_id)
- `idx_task_statistics_stat_date` (stat_date)
- `idx_task_statistics_user_date` (user_id, stat_date)

### productivity_metrics（生产力指标表）
**描述**: 存储生产力相关指标

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 记录唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | - | 用户ID |
| metric_date | DATE | NOT NULL | - | 指标日期 |
| metric_type | VARCHAR(50) | NOT NULL | - | 指标类型 |
| metric_value | DECIMAL(10,4) | NOT NULL | - | 指标值 |
| target_value | DECIMAL(10,4) | - | NULL | 目标值 |
| unit | VARCHAR(20) | - | NULL | 单位 |
| metadata | NVARCHAR(MAX) | - | NULL | 元数据(JSON) |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |

**索引**:
- `idx_productivity_metrics_user_id` (user_id)
- `idx_productivity_metrics_metric_date` (metric_date)
- `idx_productivity_metrics_metric_type` (metric_type)
- `idx_productivity_metrics_user_type_date` (user_id, metric_type, metric_date)

### system_logs（系统日志表）
**描述**: 存储系统操作日志

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 日志唯一标识 |
| user_id | UNIQUEIDENTIFIER | FOREIGN KEY | NULL | 用户ID |
| log_level | VARCHAR(20) | NOT NULL | 'info' | 日志级别 |
| log_type | VARCHAR(50) | NOT NULL | - | 日志类型 |
| message | NVARCHAR(MAX) | NOT NULL | - | 日志消息 |
| context | NVARCHAR(MAX) | - | NULL | 上下文信息(JSON) |
| ip_address | VARCHAR(45) | - | NULL | IP地址 |
| user_agent | NVARCHAR(MAX) | - | NULL | 用户代理 |
| request_id | VARCHAR(100) | - | NULL | 请求ID |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |

**索引**:
- `idx_system_logs_user_id` (user_id)
- `idx_system_logs_log_level` (log_level)
- `idx_system_logs_log_type` (log_type)
- `idx_system_logs_created_at` (created_at)
- `idx_system_logs_request_id` (request_id)

---

## ⚙️ 系统配置表

### system_configs（系统配置表）
**描述**: 存储系统配置信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 配置唯一标识 |
| config_key | VARCHAR(100) | UNIQUE NOT NULL | - | 配置键 |
| config_value | NVARCHAR(MAX) | NOT NULL | - | 配置值 |
| config_type | VARCHAR(20) | NOT NULL | 'string' | 配置类型 |
| description | NVARCHAR(MAX) | - | NULL | 配置描述 |
| is_public | BIT | NOT NULL | 0 | 是否公开 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_system_configs_config_key` (config_key)
- `idx_system_configs_is_public` (is_public)

### feature_flags（功能开关表）
**描述**: 存储功能开关配置

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | UNIQUEIDENTIFIER | PRIMARY KEY | NEWID() | 开关唯一标识 |
| feature_name | VARCHAR(100) | UNIQUE NOT NULL | - | 功能名称 |
| is_enabled | BIT | NOT NULL | 0 | 是否启用 |
| enabled_for | NVARCHAR(MAX) | - | NULL | 启用范围(JSON) |
| rollout_percentage | INTEGER | NOT NULL | 0 | 灰度比例 |
| description | NVARCHAR(MAX) | - | NULL | 功能描述 |
| created_at | DATETIME2 | NOT NULL | GETDATE() | 创建时间 |
| updated_at | DATETIME2 | NOT NULL | GETDATE() | 更新时间 |

**索引**:
- `idx_feature_flags_feature_name` (feature_name)
- `idx_feature_flags_is_enabled` (is_enabled)

---

## 🔍 索引设计

### 性能优化索引

#### 复合索引
- `idx_tasks_user_status_priority` (user_id, status, priority)
- `idx_tasks_user_category_status` (user_id, category, status)
- `idx_tasks_user_time_range` (user_id, start_time, end_time)
- `idx_reminders_user_status_time` (user_id, status, reminder_time)
- `idx_user_activities_user_type_time` (user_id, activity_type, created_at)

#### 过滤索引
- `idx_tasks_active` (user_id, status) WHERE status IN ('pending', 'in_progress')
- `idx_reminders_pending` (user_id, reminder_time) WHERE status = 'pending'
- `idx_user_sessions_active` (user_id, expires_at) WHERE is_active = 1

#### 覆盖索引
- `idx_tasks_list` (user_id, status, priority, title, start_time, end_time)
- `idx_reminders_list` (user_id, status, title, reminder_time, channels)

### 全文搜索索引
- `idx_tasks_search` FULLTEXT (title, description)
- `idx_task_templates_search` FULLTEXT (name, description)

---

## 🔗 数据关系图

### 主要关系
```
users (1) ←→ (N) tasks
users (1) ←→ (N) user_profiles
users (1) ←→ (N) user_sessions
users (1) ←→ (N) user_oauth_accounts

tasks (1) ←→ (N) task_details
tasks (1) ←→ (N) task_dependencies
tasks (1) ←→ (N) reminders
tasks (1) ←→ (N) timeline_nodes
tasks (1) ←→ (N) time_blocks

tasks (N) ←→ (1) task_categories
tasks (N) ←→ (1) tasks (parent_task_id)

users (1) ←→ (N) user_activities
users (1) ←→ (N) task_statistics
users (1) ←→ (N) productivity_metrics
```

### 外键约束
- `tasks.user_id` → `users.id`
- `task_details.task_id` → `tasks.id`
- `task_dependencies.task_id` → `tasks.id`
- `task_dependencies.depends_on_task_id` → `tasks.id`
- `reminders.task_id` → `tasks.id`
- `timeline_nodes.task_id` → `tasks.id`
- `time_blocks.task_id` → `tasks.id`

---

## 🔄 数据迁移策略

### 版本管理
- 使用Entity Framework Core迁移工具
- 每个变更都有对应的迁移脚本
- 支持向前和向后兼容

### 数据备份
- 定期全量备份
- 实时增量备份
- 多地域备份存储

### 数据清理
- 定期清理过期会话
- 归档历史数据
- 清理无效记录

---

## 📝 总结

这个数据库设计文档提供了智能提醒事项Web App的完整数据存储方案，包括：

1. **用户管理表**: 用户信息、认证、会话、第三方账户
2. **任务管理表**: 任务基本信息、详情、依赖关系、分类、模板
3. **时间线管理表**: 时间线节点、事件、甘特图数据、时间块
4. **提醒系统表**: 提醒信息、规则、历史、通知设置
5. **数据分析表**: 用户活动、任务统计、生产力指标、系统日志
6. **系统配置表**: 系统配置、功能开关

设计遵循了数据库设计的最佳实践，包括规范化、性能优化、扩展性和安全性考虑，为应用提供了可靠的数据存储基础。
